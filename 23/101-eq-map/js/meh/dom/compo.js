import { Leaf, ToStr } from "../model/leaf.js";
const log = console.log;
export var defs;
(function (defs) {
    //  //
    defs.createElement = (type, first, ...rest) => {
        if (typeof first == "object") {
            if (!("isElement" in first || first instanceof Leaf || first instanceof ToStr)) {
                return {
                    isElement: true,
                    type,
                    props: first,
                    parts: rest
                };
            }
        }
        return {
            isElement: true,
            type,
            parts: first ? [first, ...rest] : undefined
        };
    };
})(defs || (defs = {}));
//
export class Component {
    e = null;
    partsList = new Set;
    refs = new Set();
    constructor(def, ce) {
        this.e = this.createElement(def, ce);
    }
    createElement(def, ce) {
        const { type, props, parts } = def;
        const e = document.createElement(type);
        if (parts)
            this.createParts(e, parts);
        if (props)
            this.bindProps(props, e);
        if (ce)
            ce.appendChild(e);
        return e;
    }
    bindProps(def, e) {
        for (const [name, value] of Object.entries(def)) {
            if (name == "attrs")
                this.bindAttrs(value, e);
            else if (name == "class")
                this.bindClass(value, e);
            else if (name == "style" && e instanceof HTMLElement)
                this.bindStyle(value, e);
            else
                bind(e, name, value, this.refs);
        }
    }
    bindClass(def, e) {
        if (def instanceof Array) {
            for (const subdef of def)
                this.bindClass(subdef, e);
        }
        if (typeof def == "string" || def instanceof Leaf) {
            bind(e, "className", def, this.refs);
        }
        else if (typeof def == "object") {
            for (const [name, value] of Object.entries(def)) {
                bindClass(e, name, value, this.refs);
            }
        }
    }
    bindAttrs(def, e) {
        for (const [name, value] of Object.entries(def)) {
            log("attr", name, value);
            bind(e, name, value, this.refs);
        }
    }
    bindStyle(def, e) {
        for (const [name, value] of Object.entries(def)) {
            bind(e.style, name, value, this.refs);
        }
    }
    createParts(e, def) {
        this.partsList.add(new Parts(this, e, def));
    }
    createPart(def, ce) {
        if (def == null)
            return;
        if (typeof def == "object" && "isElement" in def) {
            return this.createElement(def, ce);
        }
        const n = document.createTextNode("");
        bind(n, "nodeValue", def, this.refs);
        ce.appendChild(n);
    }
    terminate() {
        this.partsList.forEach(i => i.terminate());
        this.partsList.clear();
        this.e = null;
    }
}
class Parts {
    compo;
    e;
    constructor(compo, e, def) {
        this.compo = compo;
        this.e = e;
        for (const partdef of def)
            compo.createPart(partdef, e);
    }
    terminate() {
        ;
    }
}
const bind = (target, name, value, refs) => {
    if (value instanceof Leaf) {
        const update = (value) => {
            target[name] = value;
        };
        const ref = value.ref(() => { target[name] = value.value; });
        refs.add(ref);
    }
    else if (value instanceof ToStr) {
        refs.add(value.ref(() => { target[name] = value.value; }));
    }
    else
        target[name] = value;
};
const bindClass = (e, name, value, refs) => {
    if (value instanceof Leaf) {
        refs.add(value.ref((value) => e.classList.toggle(name, value)));
    }
    else {
        e.classList.toggle(name, value);
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcG8uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi90cy1zcmMvbWVoL2RvbS9jb21wby50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQVUsSUFBSSxFQUFZLEtBQUssRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRWpFLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUM7QUFNeEIsTUFBTSxLQUFXLElBQUksQ0E0RHBCO0FBNURELFdBQWlCLElBQUk7SUFxQ3BCLE1BQU07SUFFTyxrQkFBYSxHQUFHLENBQUUsSUFBYSxFQUFFLEtBQXNCLEVBQUUsR0FBSSxJQUFjLEVBQWEsRUFBRTtRQUV0RyxJQUFJLE9BQU8sS0FBSyxJQUFJLFFBQVEsRUFDNUI7WUFDQyxJQUFJLENBQUUsQ0FBRSxXQUFXLElBQUksS0FBSyxJQUFJLEtBQUssWUFBWSxJQUFJLElBQUksS0FBSyxZQUFZLEtBQUssQ0FBRSxFQUNqRjtnQkFDQyxPQUFPO29CQUNOLFNBQVMsRUFBRSxJQUFJO29CQUNmLElBQUk7b0JBQ0osS0FBSyxFQUFFLEtBQUs7b0JBQ1osS0FBSyxFQUFFLElBQUk7aUJBQ1gsQ0FBQzthQUNGO1NBQ0Q7UUFFRCxPQUFPO1lBQ04sU0FBUyxFQUFFLElBQUk7WUFDZixJQUFJO1lBQ0osS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBRSxLQUFLLEVBQUUsR0FBRyxJQUFJLENBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUztTQUM3QyxDQUFDO0lBQ0gsQ0FBQyxDQUFBO0FBQ0YsQ0FBQyxFQTVEZ0IsSUFBSSxLQUFKLElBQUksUUE0RHBCO0FBRUQsRUFBRTtBQUVGLE1BQU0sT0FBTyxTQUFTO0lBRXJCLENBQUMsR0FBb0IsSUFBSSxDQUFDO0lBQzFCLFNBQVMsR0FBRyxJQUFJLEdBQWEsQ0FBQztJQUM5QixJQUFJLEdBQUcsSUFBSSxHQUFHLEVBQVcsQ0FBQztJQUUxQixZQUFhLEdBQWtCLEVBQUUsRUFBbUI7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
const log = console.log;
import { _ls } from "../ls.js";
const ls = _ls.model.exist;
/** class ExistContainer */
const _parts = Symbol();
class ExistContainer {
    /** parts */
    [_parts] = new Set;
    terminate() {
        this[_parts].forEach(part => part.terminate());
    }
}
/** class Exist */
export const _container = Symbol();
export const _addref = Symbol();
export const _removeref = Symbol();
export const _refs = Symbol();
let nextru = { exist: 1, ref: 1 };
export class Exist extends ExistContainer {
    constructor(container) {
        super();
        this[_container] = container;
        this[_container][_parts].add(this);
        ls.life.s && log(this.logform("new"));
    }
    runiq = "E" + String(nextru.exist++);
    [_container] = null;
    [_refs] = new Set;
    /** refs */
    [_addref](ref) {
        // log( this.logform( "addref", `${ ref.runiq }` ) );
        this[_refs].add(ref);
    }
    [_removeref](ref) {
        this[_refs].delete(ref);
        ls.ref.s && log(this.logform("removeref", `${ref.runiq}`));
    }
    /** life */
    terminate() {
        this[_refs].forEach(ref => ref.ref_term());
        this[_container]?.[_parts].delete(this);
        this[_container] = null;
        super.terminate();
        ls.life.s && log(this.logform("old"));
    }
    /** log */
    logform(event, msg = "") { return `Exist ${this.runiq} ${event} ${msg}`; }
}
/** namespace Exist */
(function (Exist) {
    const _new_source = Symbol();
    class Ref {
        acts;
        refcon;
        _source;
        constructor(refcon, acts, source) {
            this.acts = acts;
            ls.life.s && log(this.logform("new"));
            (this.refcon = refcon).add(this);
            this.source = source;
        }
        runiq = "R" + String(nextru.ref++);
        set source(news) {
            if (news === this._source)
                return;
            let olds = this._source;
            olds?.[_removeref](this);
            this._source = news;
            news?.[_addref](this);
            ls.src.s && log(this.runiq, "set source", news?.runiq ?? "..", olds?.runiq ?? "..");
            this._new_source(news, olds);
            news = olds = undefined;
        }
        /** event */
        _new_source(news, olds) {
            // log( this.logform( "new_src", `${ news?.runiq || "x" } ${ olds?.runiq || "x" }` ) );
            olds && this.acts?.old_source?.();
            news && this.acts?.new_source?.(news);
        }
        /** life.s */
        ref_term() {
            this.source = undefined;
            this.refcon?.remove(this);
            this.refcon = undefined;
            ls.life.s && log(this.logform("old"));
        }
        /** log form */
        logform(event, msg = "") { return `${this.runiq} ${event} ${msg}`; }
    }
    Exist.Ref = Ref;
})(Exist || (Exist = {}));
(function (Exist) {
    var Ref;
    (function (Ref) {
        class Container {
            items = new Set;
            add(ref) { this.items.add(ref); }
            remove(ref) { this.items.delete(ref); }
            forEach(fn) {
                this.items.forEach(ref => fn(ref));
            }
            refs_term() {
                this.items.forEach(ref => ref.ref_term());
            }
            get size() { return this.items.size; }
        }
        Ref.Container = Container;
    })(Ref = Exist.Ref || (Exist.Ref = {}));
})(Exist || (Exist = {}));
/**  */
export const root = new ExistContainer();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhpc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi90cy1zcmMvbWVoL21vZGVsL2V4aXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUM7QUFFeEIsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUMvQixNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQztBQUUzQiwyQkFBMkI7QUFFM0IsTUFBTSxNQUFNLEdBQUcsTUFBTSxFQUFFLENBQUM7QUFFeEIsTUFBTSxjQUFjO0lBRW5CLFlBQVk7SUFFSSxDQUFFLE1BQU0sQ0FBRSxHQUFHLElBQUksR0FBYSxDQUFFO0lBRXpDLFNBQVM7UUFFZixJQUFJLENBQUUsTUFBTSxDQUFFLENBQUMsT0FBTyxDQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFFLENBQUM7SUFDcEQsQ0FBQztDQUNEO0FBR0Qsa0JBQWtCO0FBRWxCLE1BQU0sQ0FBQyxNQUFNLFVBQVUsR0FBRyxNQUFNLEVBQUUsQ0FBQztBQUNuQyxNQUFNLENBQUMsTUFBTSxPQUFPLEdBQUcsTUFBTSxFQUFFLENBQUM7QUFDaEMsTUFBTSxDQUFDLE1BQU0sVUFBVSxHQUFHLE1BQU0sRUFBRSxDQUFDO0FBQ25DLE1BQU0sQ0FBQyxNQUFNLEtBQUssR0FBRyxNQUFNLEVBQUUsQ0FBQztBQUU5QixJQUFJLE1BQU0sR0FBRyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDO0FBRWxDLE1BQU0sT0FBTyxLQUFNLFNBQVEsY0FBYztJQUV4QyxZQUFhLFNBQTBCO1FBRXRDLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFFLFVBQVUsQ0FBRSxHQUFHLFNBQVMsQ0FBQztRQUMvQixJQUFJLENBQUUsVUFBVSxDQUFFLENBQUUsTUFBTSxDQUFF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
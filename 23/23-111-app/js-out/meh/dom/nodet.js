import { Exist, Leafr, StrSrcFactory } from "../model/index.js";
import { defs } from "./defs.js";
import { createParts } from "./parts.js";
const log = console.log;
/** class Nodet */
export class Nodet extends Exist {
    constructor(owner, def, ce, rel) {
        super(owner);
        if (def instanceof defs.Element)
            this.node = this.createElement(def);
        else
            this.node = this.createText(def);
        ce && ce.insertBefore(this.node, rel || null);
    }
    /**  */
    node;
    parts;
    srcs = new Set;
    /** 値リアクティブなテキストノードを生成 */
    createText(value) {
        const n = document.createTextNode("");
        if (value instanceof StrSrcFactory) {
            new Ref(this.srcs, value, str => n.nodeValue = str);
        }
        else
            n.nodeValue = "" + value;
        return n;
    }
    /** DOMエレメントを生成し、リアクティブな値モデルと構造モデルをエレメントに結合。 */
    createElement(def) {
        const e = document.createElement(def.type);
        const { style, acts } = def.chars || {};
        if (def.parts)
            this.parts = createParts(this, def.parts, e);
        if (style) {
            for (const [name, value] of Object.entries(style)) {
                this.bindStyle(e.style, name, value);
            }
        }
        if (acts)
            for (const [name, act] of Object.entries(acts))
                this.bindAction(e, name, act);
        return e;
    }
    /** 諸属性値をリアクティブに結合 */
    bindStyle(s, name, value) {
        if (value instanceof StrSrcFactory) {
            new Ref(this.srcs, value, str => { s[name] = str; });
        }
        else
            s[name] = "" + value;
    }
    bindAction(e, name, act) {
        e.addEventListener(name, act);
    }
    /**  */
    terminate() {
        this.node?.parentNode?.removeChild(this.node);
        this.srcs.forEach(source => source.release());
        this.srcs.clear();
        delete this.node;
        super.terminate();
    }
}
/** Ref */
class Ref extends Leafr.Ref {
    update;
    constructor(coll, fac, update) {
        super();
        this.update = update;
        coll.add(this);
        const src = fac.createStrSrc();
        this.tostr = src.tostr;
        this.source = src.source;
    }
    tostr;
    /**  */
    getstring() { return this.source ? this.tostr(this.source.value) : ""; }
    /**  */
    onSourceChange() { this.update(this.getstring()); }
    onValueChange(newv, oldv) { this.update(this.getstring()); }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi90cy1zcmMvbWVoL2RvbS9ub2RldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQVMsS0FBSyxFQUFFLEtBQUssRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN2RSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2pDLE9BQU8sRUFBaUIsV0FBVyxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ3hELE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUM7QUFHeEIsa0JBQWtCO0FBRWxCLE1BQU0sT0FBTyxLQUFNLFNBQVEsS0FBSztJQUUvQixZQUFhLEtBQWEsRUFBRSxHQUFlLEVBQUUsRUFBWSxFQUFFLEdBQVk7UUFFdEUsS0FBSyxDQUFFLEtBQUssQ0FBRSxDQUFDO1FBRWYsSUFBSSxHQUFHLFlBQVksSUFBSSxDQUFDLE9BQU87WUFBRyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUUsR0FBRyxDQUFFLENBQUM7O1lBQ25FLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBRSxHQUFHLENBQUUsQ0FBQztRQUV4QyxFQUFFLElBQUksRUFBRSxDQUFDLFlBQVksQ0FBRSxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsSUFBSSxJQUFJLENBQUUsQ0FBQztJQUNqRCxDQUFDO0lBRUQsT0FBTztJQUVHLElBQUksQ0FBVTtJQUNkLEtBQUssQ0FBbUI7SUFDeEIsSUFBSSxHQUFHLElBQUksR0FBVyxDQUFFO0lBR2xDLHlCQUF5QjtJQUVmLFVBQVUsQ0FBRSxLQUFpQjtRQUV0QyxNQUFNLENBQUMsR0FBRyxRQUFRLENBQUMsY0FBYyxDQUFFLEVBQUUsQ0FBRSxDQUFDO1FBRXhDLElBQUksS0FBSyxZQUFZLGFBQWEsRUFDbEM7WUFDQyxJQUFJLEdBQUcsQ0FBRSxJQUFJLENBQUMsSUFB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
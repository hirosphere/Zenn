import { Exist, LeafRo, StrSrcFactory } from "../model/index.js";
import { defs } from "./defs.js";
import { createParts } from "./parts.js";
const log = console.log;
export class Nodet extends Exist {
    constructor(owner, def, ce, rel) {
        super(owner);
        if (def instanceof defs.Element)
            this.node = this.createElement(def);
        else
            this.node = this.createText(def);
        ce && ce.insertBefore(this.node, rel || null);
    }
    /**  */
    node;
    parts;
    sources = new Set;
    /** 値リアクティブなテキストノードを生成 */
    createText(value) {
        const n = document.createTextNode("");
        if (value instanceof StrSrcFactory) {
            this.sources.add(new Ref(value, str => n.nodeValue = str));
        }
        else
            n.nodeValue = "" + value;
        return n;
    }
    /** 値・構造リアクティブなエレメントを生成 */
    createElement(def) {
        const e = document.createElement(def.type);
        const { style, acts } = def.chars || {};
        if (def.parts)
            this.parts = createParts(this, def.parts, e);
        if (style) {
            for (const [name, value] of Object.entries(style)) {
                this.bindStyle(e.style, name, value);
            }
        }
        if (acts)
            for (const [name, act] of Object.entries(acts))
                this.bindAction(e, name, act);
        return e;
    }
    /** 諸属性値をリアクティブに結合 */
    bindStyle(s, name, value) {
        if (value instanceof StrSrcFactory) {
            this.sources.add(new Ref(value, str => { s[name] = str; }));
        }
        else
            s[name] = "" + value;
    }
    bindAction(e, name, act) {
        e.addEventListener(name, act);
    }
    /**  */
    terminate() {
        this.node?.parentNode?.removeChild(this.node);
        this.sources.forEach(source => source.release());
        this.sources.clear();
        delete this.node;
        super.terminate();
    }
}
/** Ref */
class Ref extends LeafRo.Ref {
    update;
    constructor(fac, update) {
        super();
        this.update = update;
        const src = fac.createStrSrc();
        this.tostr = src.tostr;
        this.source = src.source;
    }
    tostr;
    /**  */
    getstring() { return this.source ? this.tostr(this.source.value) : ""; }
    /**  */
    onSourceChange() { this.update(this.getstring()); }
    onValueChange(newv, oldv) { this.update(this.getstring()); }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi90cy1zcmMvbWVoL2RvbS9ub2RldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQVMsS0FBSyxFQUFFLE1BQU0sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN4RSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2pDLE9BQU8sRUFBaUIsV0FBVyxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ3hELE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUM7QUFPeEIsTUFBTSxPQUFPLEtBQU0sU0FBUSxLQUFLO0lBRS9CLFlBQWEsS0FBYSxFQUFFLEdBQWUsRUFBRSxFQUFZLEVBQUUsR0FBWTtRQUV0RSxLQUFLLENBQUUsS0FBSyxDQUFFLENBQUM7UUFFZixJQUFJLEdBQUcsWUFBWSxJQUFJLENBQUMsT0FBTztZQUFHLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBRSxHQUFHLENBQUUsQ0FBQzs7WUFDbkUsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFFLEdBQUcsQ0FBRSxDQUFDO1FBRXhDLEVBQUUsSUFBSSxFQUFFLENBQUMsWUFBWSxDQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsR0FBRyxJQUFJLElBQUksQ0FBRSxDQUFDO0lBQ2pELENBQUM7SUFFRCxPQUFPO0lBRUcsSUFBSSxDQUFVO0lBQ2QsS0FBSyxDQUFtQjtJQUN4QixPQUFPLEdBQUcsSUFBSSxHQUFXLENBQUU7SUFHckMseUJBQXlCO0lBRWYsVUFBVSxDQUFFLEtBQWlCO1FBRXRDLE1BQU0sQ0FBQyxHQUFHLFFBQVEsQ0FBQyxjQUFjLENBQUUsRUFBRSxDQUFFLENBQUM7UUFFeEMsSUFBSSxLQUFLLFlBQVksYUFBYSxFQUNsQztZQUNDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFFLElBQUksR0FBRyxD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
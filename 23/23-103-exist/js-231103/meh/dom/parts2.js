import { defs } from "./defs.js";
import { Lian } from "../model/lian.js";
const log = console.log;
export class Parts {
    wk;
    static create(compo, ce, def) {
        return new StaticParts(new Work(compo, ce, def));
    }
    //  //
    constructor(wk) {
        this.wk = wk;
    }
}
//  //
class PartsImpl extends Parts {
    next;
}
export class StaticParts extends PartsImpl {
    constructor(wk) {
        super(wk);
        for (let partdef; partdef = this.wk.getnext(this);) {
            const node = this.wk.createPart(partdef);
            this._firstnode = this._firstnode || node;
        }
    }
    get firstnode() { return this._firstnode; }
    _firstnode;
    delete() {
        this.next?.delete();
    }
}
class ArrayParts extends PartsImpl {
    def;
    nodes = new Array;
    constructor(def, wk) {
        super(wk);
        this.def = def;
        def.source.forEach(partmodel => this.createPart(partmodel));
        if (!(def.source instanceof Lian))
            return;
        def.source.ref(this);
    }
    // Lian Ref オペレーション //
    add(start, count) {
        const order = start;
        const model = this.def.source[order];
        const rel = this.nodes[order];
        this.nodes.splice(order, 0, this.createPart(model, rel));
    }
    remove(start, count) {
        const rem = this.nodes.splice(start, count);
        log("remove", rem, start, count);
        rem.forEach(node => this.wk.ce.removeChild(node));
    }
    //  //
    createPart(model, rel) {
        const partdef = this.def.create(model);
        return this.wk.createPart(partdef, rel);
    }
    get firstnode() { return this.nodes[0]; }
    delete() {
        this.next?.delete();
    }
}
class Work {
    compo;
    ce;
    def;
    index = 0;
    constructor(compo, ce, def) {
        this.compo = compo;
        this.ce = ce;
        this.def = def;
    }
    getnext(prevparts) {
        const def = this.def[this.index++];
        if (def instanceof defs.ArrayParts) {
            prevparts.next = new ArrayParts(def, this);
            return;
        }
        return def;
    }
    createPart(def, rel) {
        return this.compo.createNode(def, this.ce, rel);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFydHMyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vdHMtc3JjL21laC9kb20vcGFydHMyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFakMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRXhDLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUM7QUFFeEIsTUFBTSxPQUFnQixLQUFLO0lBU0g7SUFQdkIsTUFBTSxDQUFDLE1BQU0sQ0FBRSxLQUFpQixFQUFFLEVBQVksRUFBRSxHQUFnQjtRQUUvRCxPQUFPLElBQUksV0FBVyxDQUFFLElBQUksSUFBSSxDQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsR0FBRyxDQUFFLENBQUUsQ0FBQztJQUN0RCxDQUFDO0lBRUQsTUFBTTtJQUVOLFlBQXVCLEVBQVM7UUFBVCxPQUFFLEdBQUYsRUFBRSxDQUFPO0lBQUksQ0FBQztDQUdyQztBQUVELE1BQU07QUFFTixNQUFlLFNBQVUsU0FBUSxLQUFLO0lBSTlCLElBQUksQ0FBZTtDQUMxQjtBQUVELE1BQU0sT0FBTyxXQUFZLFNBQVEsU0FBUztJQUV6QyxZQUFhLEVBQVM7UUFFckIsS0FBSyxDQUFFLEVBQUUsQ0FBRSxDQUFDO1FBRVosS0FBSyxJQUFJLE9BQStCLEVBQUcsT0FBTyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFFLElBQUksQ0FBRSxHQUM1RTtZQUNDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFFLE9BQU8sQ0FBRSxDQUFDO1lBQzNDLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUM7U0FDMUM7SUFDRixDQUFDO0lBRUQsSUFBVyxTQUFTLEtBQXdCLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQSxDQUFDLENBQUM7SUFDNUQsVUFB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
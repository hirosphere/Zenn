import { Exist } from "../model/exist.js";
import { Leafr } from "../model/leaf.js";
import { defs } from "./defs.js";
import { Parts } from "./parts.js";
import _ls from "../ls.js";
const ls = _ls.dom.nodet;
const log = console.log;
/** class Nodet
 *
 * DOMのElementのプロパティー(クラス名, 属性, スタイル)と要素、Textの値をリアクティブにする委譲クラス。
 *
*/
export class Nodet extends Exist {
    p_node;
    p_element;
    acts;
    pf;
    p_parts;
    constructor(composition, def, ce, rel) {
        super(composition);
        this.p_node = (def instanceof defs.Element) ?
            this.createElement(def) :
            this.createText(def);
        ce?.insertBefore(this.p_node, rel || null);
    }
    /* accessor */
    get node() {
        return this.p_node;
    }
    get e() {
        return this.p_element;
    }
    /* element */
    createElement(def) {
        const e = this.p_element = document.createElement(def.type);
        let { exist, attrs, props, acts, style } = def.echar || {};
        if (def.echar?.class) {
            this.bind_class(e, def.echar.class);
        }
        if (attrs)
            for (const [name, lol] of Object.entries(attrs)) {
                this.bind_leafr(lol, value => setattr(e, name, value));
            }
        if (props)
            for (const [name, lol] of Object.entries(props)) {
                this.bind_leafr(lol, value => e[name] = value);
            }
        if (style)
            for (const [name, lol] of Object.entries(style)) {
                this.bind_leafr(lol, value => e.style[name] = value);
            }
        if (acts)
            for (const [name, act] of Object.entries(acts)) {
                this.bind_act(e, name, act);
            }
        if (def.parts)
            this.p_parts = new Parts(this, def.parts);
        if (exist) {
            new Exist.Ref(this, { terminate: () => this.terminate() }, exist);
        }
        exist = attrs = props = acts = style = undefined;
        return e;
    }
    bind_class(e, def) {
        if (def instanceof Array)
            def.forEach(item => this.bind_class(e, item));
        else if (typeof def == "string")
            e.className = def;
        else if (typeof def == "object") {
            for (const [name, value] of Object.entries(def)) {
                this.bind_leafr(value, value => e.classList.toggle(name, value));
            }
        }
    }
    bind_act(e, name, act) {
        this.acts ??= new Map;
        if (this.acts.has(name))
            this.acts.get(name)?.push(act);
        else
            this.acts.set(name, [act]);
        e.addEventListener(name, act);
    }
    /** text */
    createText(text) {
        const node = document.createTextNode("");
        this.bind_leafr(text, (lettr) => { node.nodeValue = lettr; });
        return node;
    }
    /** リアクティブ核心 */
    bind_leafr(text, update) {
        if (text instanceof Leafr) {
            new Leafr.Ref(this, { new_value: update }, text);
        }
        else
            update(text);
    }
    ;
    /** life */
    terminate() {
        if (this.p_element && this.acts) {
            for (let [name, acts] of this.acts) {
                ls.$("event hdr", (...a) => log(...a, name));
                acts.forEach(act => this.p_element?.removeEventListener(name, act));
            }
        }
        this.p_node?.parentElement?.removeChild(this.p_node);
        this.p_node = undefined;
        this.p_element = undefined;
        this.pf?.pf_term();
        super.terminate();
    }
}
const setattr = (e, name, value) => {
    e.setAttribute(name, String(value));
};
/** */
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi90cy1zcmMvbWVoL2RvbS9ub2RldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsS0FBSyxFQUFRLE1BQU0sbUJBQW1CLENBQUM7QUFDaEQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDakMsT0FBTyxFQUFFLEtBQUssRUFBZ0IsTUFBTSxZQUFZLENBQUE7QUFDaEQsT0FBTyxHQUFHLE1BQU0sVUFBVSxDQUFDO0FBQzNCLE1BQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDO0FBQ3pCLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUM7QUFJeEI7Ozs7RUFJRTtBQUVGLE1BQU0sT0FBTyxLQUFNLFNBQVEsS0FBSztJQUVyQixNQUFNLENBQVc7SUFDakIsU0FBUyxDQUFjO0lBQ3ZCLElBQUksQ0FBdUM7SUFDM0MsRUFBRSxDQUFtQjtJQUNyQixPQUFPLENBQVk7SUFFN0IsWUFFQyxXQUFvQixFQUNwQixHQUFzQixFQUN0QixFQUEyQixFQUMzQixHQUFpQjtRQUdqQixLQUFLLENBQUUsV0FBVyxDQUFFLENBQUM7UUFFckIsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFFLEdBQUcsWUFBWSxJQUFJLENBQUMsT0FBTyxDQUFFLENBQUMsQ0FBQztZQUM5QyxJQUFJLENBQUMsYUFBYSxDQUFFLEdBQUcsQ0FBRSxDQUFDLENBQUM7WUFDM0IsSUFBSSxDQUFDLFVBQVUsQ0FBRSxHQUFHLENBQUUsQ0FDdEI7UUFFRCxFQUFFLEVBQUUsWUFBWSxDQUFFLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxJQUFJLElBQUksQ0FBRSxDQUFDO0lBQzlDLENBQUM7SUFFRCxjQUFjO0lBRWQsSUFBVyxJQUFJO1FBRWQsT0FBTyxJQUFJLENB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
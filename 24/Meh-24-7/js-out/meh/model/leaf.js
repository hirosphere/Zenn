import { Exist } from "./exist.js";
import { _composition, _refs, _setvalue } from "./shadow-props.js";
import { Branch } from "./branch.js";
const log = console.log;
export class Leafr extends Exist {
    _value;
    _rel;
    static make(container, lol) {
        return lol instanceof Leafr ? lol : new Leafr(container, lol);
    }
    ;
    static values(composition, values) {
        return values.map(value => new Leafr(composition, value));
    }
    /*  */
    constructor(composition, _value, _rel) {
        super(composition);
        this._value = _value;
        this._rel = _rel;
    }
    /* value */
    get v() { return this._value; }
    get val() { return this._value; }
    get value() { return this._value; }
    get() { return this._value; }
    [_setvalue](new_v, changer) {
        if (new_v === this._value)
            return false;
        const old_v = this._value;
        this._value = new_v;
        this._rel?.(new_v, old_v);
        if (changer != this[_composition] && this[_composition] instanceof Branch) {
            this[_composition]?.update();
        }
        this[_refs].forEach(ref => {
            (ref instanceof Leafr.Ref)
                && ref.notify_new_value(new_v, old_v);
        });
        return true;
    }
    /* life */
    terminate() {
        this._rel = undefined;
        super.terminate();
    }
}
(function (Leafr) {
    /* Ref */
    class Ref extends Exist.Ref {
        leafr_acts;
        constructor(owner, leafr_acts, source) {
            super(owner, leafr_acts, source);
            this.leafr_acts = leafr_acts;
            this.notify_new_value(source.value);
        }
        notify_new_value(new_v, old_v) {
            this.leafr_acts.new_value?.(new_v, old_v);
        }
    }
    Leafr.Ref = Ref;
    /** プリミティブ型シュガー */
    class String extends Leafr {
    }
    Leafr.String = String;
    class Number extends Leafr {
    }
    Leafr.Number = Number;
    class Boolean extends Leafr {
    }
    Leafr.Boolean = Boolean;
    ;
})(Leafr || (Leafr = {}));
/** Leaf RW  */
export class Leaf extends Leafr {
    static make(container, lol) {
        return lol instanceof Leaf ? lol : new Leaf(container, lol);
    }
    ;
    /**  */
    set(newv, changer) {
        return this[_setvalue](newv, changer);
    }
    set v(newv) { this[_setvalue](newv); }
    set val(newv) { this[_setvalue](newv); }
    set value(newv) { this[_setvalue](newv); }
    get v() { return this._value; }
    get val() { return this._value; }
    get value() { return this._value; }
}
(function (Leaf) {
    /** class Ref < V > */
    class Ref extends Leafr.Ref {
    }
    Leaf.Ref = Ref;
})(Leaf || (Leaf = {}));
(function (Leaf) {
    /** プリミティブ型シュガー */
    class String extends Leaf {
    }
    Leaf.String = String;
    class Number extends Leaf {
    }
    Leaf.Number = Number;
    class Boolean extends Leaf {
    }
    Leaf.Boolean = Boolean;
    ;
})(Leaf || (Leaf = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGVhZi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3RzLXNyYy9tZWgvbW9kZWwvbGVhZi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ25DLE9BQU8sRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ25FLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDckMsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQztBQU14QixNQUFNLE9BQU8sS0FBWSxTQUFRLEtBQUs7SUFlTztJQUFzQjtJQWJsRSxNQUFNLENBQUMsSUFBSSxDQUFTLFNBQTJCLEVBQUUsR0FBcUI7UUFFckUsT0FBTyxHQUFHLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFTLFNBQVMsRUFBRSxHQUFHLENBQUUsQ0FBQztJQUN4RSxDQUFDO0lBQUEsQ0FBQztJQUVGLE1BQU0sQ0FBQyxNQUFNLENBQVMsV0FBbUIsRUFBRSxNQUFhO1FBRXZELE9BQU8sTUFBTSxDQUFDLEdBQUcsQ0FBRSxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksS0FBSyxDQUFFLFdBQVcsRUFBRSxLQUFLLENBQUUsQ0FBRSxDQUFDO0lBQy9ELENBQUM7SUFHRCxNQUFNO0lBRU4sWUFBYSxXQUFtQixFQUFZLE1BQVUsRUFBWSxJQUFxQjtRQUV0RixLQUFLLENBQUUsV0FBVyxDQUFFLENBQUM7UUFGc0IsV0FBTSxHQUFOLE1BQU0sQ0FBSTtRQUFZLFNBQUksR0FBSixJQUFJLENBQWlCO0lBR3ZGLENBQUM7SUFFRCxXQUFXO0lBRVgsSUFBVyxDQUFDLEtBQVMsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUMxQyxJQUFXLEdBQUcsS0FBUyxPQUFPLElBQUksQ0FBQyxN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
import { defs } from "./defs.js";
import * as nodet from "./nodet.js";
export const create_place = (ce, def, rel_n) => (next_place(ce, def, 0));
const next_place = (ce, def, pos) => {
    const cur = def[pos];
    if (cur instanceof defs.Place) {
        pos++;
        if (cur instanceof defs.Each) {
            return new EachPlace(ce, cur, def, pos);
        }
        return;
    }
    if (cur !== undefined) {
        return new StaticPlace(ce, def, pos);
    }
};
/* */
export class Place {
    next;
    make_part(df, pdef) {
        if (pdef instanceof nodet.Nodet) {
            pdef.node && df.appendChild(pdef.node);
            return pdef.node;
        }
        else if (pdef instanceof Node) {
            df.appendChild(pdef);
            return pdef;
        }
        else if (!(pdef instanceof defs.Place)) {
            const text = new nodet.Text(pdef);
            text.node && df.appendChild(text.node);
            return text.node;
        }
    }
    destruct() { }
}
class StaticPlace extends Place {
    constructor(ce, def, pos) {
        super();
        const df = new DocumentFragment;
        while (pos < def.length) {
            const pdef = def[pos];
            const part = this.make_part(df, pdef);
            if (!part)
                break;
            this._first_node_ ??= part;
            pos++;
        }
        ce.appendChild(df);
        this.next = next_place(ce, def, pos);
    }
    get first_node() {
        return this._first_node_;
    }
    _first_node_;
}
class EachPlace extends Place {
    ce;
    src;
    create_node;
    nodes = new Map;
    constructor(ce, def, parts_def, pos) {
        super();
        this.ce = ce;
        this.src = def.source;
        this.create_node = def.create_node;
        def.source.add_ref(this);
        this.next = next_place(ce, parts_def, pos);
    }
    add({ src, start, next }) {
        const df = new DocumentFragment;
        for (let pos = start; pos < next; pos++) {
            const order = src.orders[pos];
            if (this.nodes.has(order))
                return;
            const node = this.make_part(df, this.create_node(order));
            node && this.nodes.set(order, node);
        }
        const next_ord = this.src.orders[next];
        this.ce.insertBefore(df, (this.nodes.get(next_ord) ??
            this.next?.first_node ??
            null));
    }
    remove({ orders }) {
        orders.forEach(order => this.remove_node(order));
    }
    remove_node(order) {
        const node = this.nodes.get(order);
        if (!node)
            return;
        this.ce.removeChild(node);
    }
    get first_node() {
        return this.nodes.get(this.src.orders[0]);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFydHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi90cy1zcmMvbWVoL2RvbS9wYXJ0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFHQSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2pDLE9BQU8sS0FBSyxLQUFLLE1BQU0sWUFBWSxDQUFDO0FBRXBDLE1BQU0sQ0FBQyxNQUFNLFlBQVksR0FDekIsQ0FDQyxFQUFZLEVBQ1osR0FBZ0IsRUFDaEIsS0FBYyxFQUVLLEVBQUUsQ0FDdEIsQ0FDQyxVQUFVLENBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUUsQ0FDeEIsQ0FBQztBQUVGLE1BQU0sVUFBVSxHQUNoQixDQUNDLEVBQVksRUFDWixHQUFnQixFQUNoQixHQUFZLEVBRU8sRUFBRTtJQUVyQixNQUFNLEdBQUcsR0FBRyxHQUFHLENBQUUsR0FBRyxDQUFFLENBQUM7SUFFdkIsSUFBSSxHQUFHLFlBQVksSUFBSSxDQUFDLEtBQUssRUFDN0I7UUFDQyxHQUFHLEVBQUcsQ0FBRTtRQUVSLElBQUksR0FBRyxZQUFZLElBQUksQ0FBQyxJQUFJLEVBQzVCO1lBQ0MsT0FBTyxJQUFJLFNBQVMsQ0FBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUUsQ0FBQztTQUMxQztRQUVELE9BQVE7S0FDUjtJQUVELElBQUksR0FBRyxLQUFLLFNBQVMsRUFDckI7UUFDQyxPQUFPLElBQUksV0FBVyxDQUFFLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFFLENBQUM7S0FDdkM7QUFDRixDQUFDLENBQUM7QUFFRixLQUFLO0FBR0wsTUFBTSxPQUFnQixLQUFLO0lBRWhCLElBQUksQ0FBWTtJQUdoQixTQUFTLENBRWxCLEVBQXFCLEVBQ3JCLElBQWdCO1FBSWhCLElBQUksSUFBSSxZQUFZLEtBQUssQ0FBQyxLQUFLLEVBQy9CO1lBQ0MsSUFBSSxDQUFDLElBQUksSUFBSSxFQUFFLENB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
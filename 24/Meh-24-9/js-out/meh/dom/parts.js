import { defs } from "./defs.js";
import * as nodet from "./nodet.js";
export const create_place = (ce, def, rel_n) => (next_place(ce, def, 0));
const next_place = (ce, def, pos) => {
    const cur = def[pos];
    if (cur instanceof defs.Place) {
        pos++;
        if (cur instanceof defs.Each) {
            return new EachPlace(ce, cur, def, pos);
        }
        return;
    }
    if (cur !== undefined) {
        return new StaticPlace(ce, def, pos);
    }
};
/* */
export class Place {
    next;
    make_part(df, pdef) {
        if (pdef instanceof nodet.Nodet) {
            pdef.node && df.appendChild(pdef.node);
            return pdef;
        }
        else if (pdef instanceof Node) {
            df.appendChild(pdef);
            return pdef;
        }
        else if (!(pdef instanceof defs.Place)) {
            const text = new nodet.Text(pdef);
            text.node && df.appendChild(text.node);
            return text;
        }
    }
    destruct() { }
}
class StaticPlace extends Place {
    constructor(ce, def, pos) {
        super();
        const df = new DocumentFragment;
        while (pos < def.length) {
            const pdef = def[pos];
            const part = this.make_part(df, pdef);
            this._first_node_ ??=
                (part instanceof Node ?
                    part :
                    part?.node);
            if (!part)
                break;
            pos++;
        }
        ce.appendChild(df);
        this.next = next_place(ce, def, pos);
    }
    get first_node() {
        return this._first_node_;
    }
    _first_node_;
}
class EachPlace extends Place {
    ce;
    src;
    create_node;
    parts = new Map;
    constructor(ce, def, parts_def, pos) {
        super();
        this.ce = ce;
        this.src = def.source;
        this.create_node = def.create_node;
        def.source.add_ref(this);
        this.next = next_place(ce, parts_def, pos);
    }
    add({ src, start, next }) {
        const df = new DocumentFragment;
        for (let pos = start; pos < next; pos++) {
            const order = src.orders[pos];
            if (this.parts.has(order))
                return;
            const part = this.make_part(df, this.create_node(order));
            const node = part instanceof Node ? part : part?.node;
            node && this.parts.set(order, node);
        }
        const next_ord = this.src.orders[next];
        this.ce.insertBefore(df, (this.parts.get(next_ord) ??
            this.next?.first_node ??
            null));
    }
    remove({ src, start, next }) {
    }
    get first_node() {
        return this.parts.get(this.src.orders[0]);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFydHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi90cy1zcmMvbWVoL2RvbS9wYXJ0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFHQSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2pDLE9BQU8sS0FBSyxLQUFLLE1BQU0sWUFBWSxDQUFDO0FBRXBDLE1BQU0sQ0FBQyxNQUFNLFlBQVksR0FDekIsQ0FDQyxFQUFZLEVBQ1osR0FBZ0IsRUFDaEIsS0FBYyxFQUVLLEVBQUUsQ0FDdEIsQ0FDQyxVQUFVLENBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUUsQ0FDeEIsQ0FBQztBQUVGLE1BQU0sVUFBVSxHQUNoQixDQUNDLEVBQVksRUFDWixHQUFnQixFQUNoQixHQUFZLEVBRU8sRUFBRTtJQUVyQixNQUFNLEdBQUcsR0FBRyxHQUFHLENBQUUsR0FBRyxDQUFFLENBQUM7SUFFdkIsSUFBSSxHQUFHLFlBQVksSUFBSSxDQUFDLEtBQUssRUFDN0I7UUFDQyxHQUFHLEVBQUcsQ0FBRTtRQUVSLElBQUksR0FBRyxZQUFZLElBQUksQ0FBQyxJQUFJLEVBQzVCO1lBQ0MsT0FBTyxJQUFJLFNBQVMsQ0FBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUUsQ0FBQztTQUMxQztRQUVELE9BQVE7S0FDUjtJQUVELElBQUksR0FBRyxLQUFLLFNBQVMsRUFDckI7UUFDQyxPQUFPLElBQUksV0FBVyxDQUFFLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFFLENBQUM7S0FDdkM7QUFDRixDQUFDLENBQUM7QUFFRixLQUFLO0FBR0wsTUFBTSxPQUFnQixLQUFLO0lBRWhCLElBQUksQ0FBWTtJQUdoQixTQUFTLENBRWxCLEVBQXFCLEVBQ3JCLElBQWdCO1FBSWhCLElBQUksSUFBSSxZQUFZLEtBQUssQ0FBQyxLQUFLLEVBQy9CO1lBQ0MsSUFBSSxDQUFDLElBQUksSUFBSSxFQUFFLENB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